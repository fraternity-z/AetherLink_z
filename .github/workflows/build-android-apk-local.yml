name: Build Android APK (Local)

on:
  workflow_dispatch:
    inputs:
      versionName:
        description: Android versionName (e.g. 1.2.3)
        required: false
      versionCode:
        description: Android versionCode (integer)
        required: false

jobs:
  android-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      CI: true
      EXPO_NO_TELEMETRY: "1"
      VERSION_NAME: ${{ github.event.inputs.versionName }}
      VERSION_CODE: ${{ github.event.inputs.versionCode }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect config changes
        id: config_changes
        uses: dorny/paths-filter@v3
        with:
          base: origin/main
          filters: |
            requires-prebuild:
              - 'app.json'
              - 'app.config.*'
              - 'package.json'
              - 'package-lock.json'
              - 'config/**'
              - 'scripts/**'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept licenses and install SDK packages
        run: |
          yes | sdkmanager --licenses >/dev/null || true
          sdkmanager --install "platforms;android-35" "build-tools;35.0.0" "platform-tools"
        shell: bash

      - name: Bump app.json version (if provided)
        run: |
          if [ -n "${VERSION_NAME}" ] || [ -n "${VERSION_CODE}" ]; then
            node -e '
              const fs = require("fs");
              const p = "app.json";
              const j = JSON.parse(fs.readFileSync(p, "utf8"));
              if (!j.expo) j.expo = {};
              if (!j.expo.android) j.expo.android = {};
              const name = process.env.VERSION_NAME;
              const code = process.env.VERSION_CODE;
              if (name) j.expo.version = name;
              if (code) j.expo.android.versionCode = parseInt(code, 10);
              fs.writeFileSync(p, JSON.stringify(j, null, 2));
              console.log("Updated app.json:", { version: j.expo.version, versionCode: j.expo.android.versionCode });
            '
          else
            echo "No custom version provided. Using existing app.json values."
          fi
        shell: bash

      - name: Prebuild native android project (Expo)
        if: steps.config_changes.outputs.requires-prebuild == 'true'
        run: npx expo prebuild --platform android --non-interactive --no-install

      - name: Skip Expo prebuild
        if: steps.config_changes.outputs.requires-prebuild != 'true'
        run: echo "Skipping Expo prebuild: no config changes detected."

      - name: Configure release signing
        run: |
          if [ -z "${ANDROID_KEYSTORE_BASE64}" ] || [ -z "${ANDROID_KEYSTORE_PASSWORD}" ] || [ -z "${ANDROID_KEY_ALIAS}" ] || [ -z "${ANDROID_KEY_PASSWORD}" ]; then
            echo "Missing signing secrets. Please set ANDROID_KEYSTORE_BASE64, ANDROID_KEYSTORE_PASSWORD, ANDROID_KEY_ALIAS, ANDROID_KEY_PASSWORD in GitHub Secrets." >&2
            exit 1
          fi
          cd android/app
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > upload-keystore.jks
          cat > signing.gradle <<'GRADLE'
          android {
              signingConfigs {
                  release {
                      storeFile file("upload-keystore.jks")
                      storePassword System.getenv("ANDROID_KEYSTORE_PASSWORD")
                      keyAlias System.getenv("ANDROID_KEY_ALIAS")
                      keyPassword System.getenv("ANDROID_KEY_PASSWORD")
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          GRADLE
          if ! grep -q "apply from: \"./signing.gradle\"" build.gradle; then
            echo 'apply from: "./signing.gradle"' >> build.gradle
          fi
        shell: bash

      - name: Build release APK with Gradle
        run: |
          cd android
          chmod +x ./gradlew
          ./gradlew assembleRelease --no-daemon --stacktrace
        shell: bash

      - name: Upload Release APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release
          path: android/app/build/outputs/apk/release/app-release.apk

      - name: Compute release metadata
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${VERSION_NAME}" ]; then
            echo "RELEASE_TAG=v${VERSION_NAME}" >> "$GITHUB_ENV"
            if [ -n "${VERSION_CODE}" ]; then
              echo "RELEASE_NAME=AetherLink_z v${VERSION_NAME} (code ${VERSION_CODE})" >> "$GITHUB_ENV"
            else
              echo "RELEASE_NAME=AetherLink_z v${VERSION_NAME}" >> "$GITHUB_ENV"
            fi
          else
            short_sha="${GITHUB_SHA::7}"
            echo "RELEASE_TAG=apk-${short_sha}" >> "$GITHUB_ENV"
            echo "RELEASE_NAME=AetherLink_z APK ${short_sha}" >> "$GITHUB_ENV"
          fi
          echo "Computed: tag=$RELEASE_TAG, name=$RELEASE_NAME"

      - name: Create GitHub Release and upload APK
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          generate_release_notes: true
          draft: false
          prerelease: false
          files: |
            android/app/build/outputs/apk/release/app-release.apk
