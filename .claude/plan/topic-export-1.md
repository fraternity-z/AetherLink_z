# 项目任务分解规划：话题导出功能

## 已明确的决策

基于用户需求和项目架构，以下技术方案已确定：

### 1. DOCX 生成库选择
- **选定方案**：使用 `docx` 库（纯 JS 实现）
- **理由**：
  - 完全兼容 React Native 环境，无需原生模块
  - 零依赖 Node.js API，适合移动端
  - 支持完整的 DOCX 特性（段落、表格、样式、图片等）
  - 社区活跃，文档完善

### 2. MCP 工具调用导出策略
- **选定方案**：完整导出（包含调用参数和结果）
- **导出格式**：
  ```markdown
  ### MCP 工具调用：search_web
  - 调用时间：2025-11-22 14:30:25
  - 参数：{"query": "React Native 性能优化", "engine": "google"}
  - 结果：
    - 标题：React Native Performance - Best Practices
    - URL：https://...
    - 摘要：...
  ```
- **安全措施**：
  - 敏感字段脱敏（如 API Key、Token、密码等）
  - 支持用户在导出时选择是否包含工具调用

### 3. 附件处理策略
- **选定方案**：仅包含文件名和类型，不嵌入内容
- **导出格式**：
  ```markdown
  ### 附件
  - 📷 image_2025_11_22.jpg (图片)
  - 📄 document.pdf (文档)
  - 📦 data.json (数据文件)
  ```
- **原因**：避免文档体积过大，提升导出性能

### 4. 思考链导出方式
- **选定方案**：用户可选（推荐方案）
- **三种模式**：
  - **完整导出**：包含思考过程和耗时
  - **仅导出摘要**：提取思考结论（使用 AI 总结）
  - **不导出**：跳过思考链内容
- **默认设置**：完整导出（保留最完整的对话记录）

### 5. 平台支持范围
- **选定方案**：仅支持移动端（iOS + Android）
- **理由**：项目重点在移动端体验，Web 平台暂不考虑
- **技术简化**：
  - 使用 `expo-sharing` 进行文件分享
  - 使用 `expo-file-system` 管理文件存储
  - 移除浏览器下载逻辑

### 6. 技术栈确定
- **DOCX 生成**：`docx` ^9.0.0
- **文件系统**：`expo-file-system` ^18.1.0
- **文件分享**：`expo-sharing` ^13.0.0
- **数据访问**：现有的 `storage/repositories/`
- **UI 组件**：React Native Paper + 现有的弹窗系统

---

## 整体规划概述

### 项目目标

为 AetherLink_z 应用添加话题导出功能，支持将对话记录导出为 DOCX 格式文档，包含完整的消息内容、思考链、MCP 工具调用和附件信息。提供灵活的导出选项和良好的用户体验。

### 技术栈

- **文档生成**：docx ^9.0.0
- **文件管理**：expo-file-system ^18.1.0, expo-sharing ^13.0.0
- **数据库访问**：现有 storage/repositories/
- **UI 框架**：React Native Paper + Expo Router
- **类型检查**：TypeScript 5.9.2

### 主要阶段

1. **阶段 1**：基础设施搭建（依赖安装、数据访问层、核心服务）
2. **阶段 2**：DOCX 生成逻辑（内容转换、样式设计、文件生成）
3. **阶段 3**：UI 集成（导出对话框、进度提示、文件分享）
4. **阶段 4**：功能完善（错误处理、性能优化、测试验证）

---

## 详细任务分解

### 阶段 1：基础设施搭建

**目标**：安装依赖包，扩展数据访问层，创建核心服务模块

#### 任务 1.1：安装 NPM 依赖

- **目标**：安装 DOCX 生成和文件管理所需的依赖
- **输入**：`package.json`
- **输出**：更新后的 `package.json` 和 `package-lock.json`
- **涉及文件**：
  - `package.json`
- **操作**：
  ```bash
  npm install docx@^9.0.0
  npm install expo-file-system@^18.1.0
  npm install expo-sharing@^13.0.0
  ```
- **预估工作量**：5 分钟

#### 任务 1.2：扩展数据访问层

- **目标**：在 `storage/repositories/` 中添加话题导出所需的数据查询方法
- **输入**：现有的 `chat.ts`, `messages.ts`, `mcp.ts`, `thinking-chains.ts`
- **输出**：扩展后的 Repository 接口
- **涉及文件**：
  - `storage/repositories/chat.ts`（添加 `getTopicWithMetadata` 方法）
  - `storage/repositories/messages.ts`（添加 `getMessagesWithRelations` 方法）
- **新增方法**：
  ```typescript
  // chat.ts
  export async function getTopicWithMetadata(topicId: string): Promise<TopicExportData> {
    // 返回话题基本信息 + 消息数量 + 创建/更新时间
  }

  // messages.ts
  export async function getMessagesWithRelations(topicId: string): Promise<MessageExportData[]> {
    // 返回消息 + 附件 + MCP 工具调用 + 思考链
  }
  ```
- **预估工作量**：30 分钟

#### 任务 1.3：创建话题导出服务

- **目标**：创建 `services/export/TopicExportService.ts` 核心服务
- **输入**：扩展后的 Repository 方法
- **输出**：完整的导出服务类
- **涉及文件**：
  - `services/export/TopicExportService.ts`（新增）
  - `services/export/types.ts`（新增，定义导出配置类型）
- **核心接口**：
  ```typescript
  export interface ExportOptions {
    includeThinking: 'full' | 'summary' | 'none'; // 思考链导出模式
    includeMcpTools: boolean; // 是否包含 MCP 工具调用
    includeAttachments: boolean; // 是否包含附件信息
    sanitizeSensitiveData: boolean; // 是否脱敏敏感信息
  }

  export class TopicExportService {
    async exportToDocx(topicId: string, options: ExportOptions): Promise<string>;
  }
  ```
- **预估工作量**：1 小时

---

### 阶段 2：DOCX 生成逻辑

**目标**：实现内容转换、样式设计和文档生成

#### 任务 2.1：Markdown 转 DOCX 段落

- **目标**：实现 Markdown 到 DOCX 的转换逻辑
- **输入**：消息内容（Markdown 格式字符串）
- **输出**：DOCX Paragraph 对象数组
- **涉及文件**：
  - `services/export/converters/MarkdownConverter.ts`（新增）
- **支持的 Markdown 语法**：
  - 标题（`#`, `##`, `###`）
  - 粗体（`**text**`）
  - 斜体（`*text*`）
  - 行内代码（`` `code` ``）
  - 代码块（` ```language ```）
  - 列表（`-`, `1.`）
  - 引用（`>`）
  - 链接（`[text](url)`）
- **技术实现**：
  - 使用正则表达式解析 Markdown 语法
  - 使用 `docx` 库的 `TextRun` 组合样式
  - 代码块使用等宽字体 + 灰色背景
- **预估工作量**：2 小时

#### 任务 2.2：思考链内容转换

- **目标**：根据导出模式转换思考链内容
- **输入**：思考链数据 + 导出模式（`full` / `summary` / `none`）
- **输出**：DOCX Section 对象
- **涉及文件**：
  - `services/export/converters/ThinkingChainConverter.ts`（新增）
- **转换逻辑**：
  - **完整模式**：导出完整思考过程 + 耗时
  - **摘要模式**：提取关键结论（使用简单的文本截断或关键词提取）
  - **不导出**：跳过此部分
- **样式设计**：
  - 使用浅蓝色背景框
  - 斜体字 + 小字号
  - 显示 "💡 思考过程（耗时 X.Xs）"
- **预估工作量**：1.5 小时

#### 任务 2.3：MCP 工具调用转换

- **目标**：将 MCP 工具调用转换为结构化表格
- **输入**：MCP 工具调用数据
- **输出**：DOCX Table 对象
- **涉及文件**：
  - `services/export/converters/McpToolConverter.ts`（新增）
- **表格结构**：
  | 字段 | 值 |
  |------|-----|
  | 工具名称 | search_web |
  | 调用时间 | 2025-11-22 14:30:25 |
  | 参数 | {"query": "..."} |
  | 结果 | {...} |
- **脱敏逻辑**：
  - 识别常见敏感字段（`apiKey`, `token`, `password`, `secret`）
  - 替换为 `***REDACTED***`
- **预估工作量**：1.5 小时

#### 任务 2.4：附件信息展示

- **目标**：在文档中列出附件信息（不嵌入内容）
- **输入**：附件元数据（文件名、类型、大小）
- **输出**：DOCX Paragraph 对象（带 emoji 图标）
- **涉及文件**：
  - `services/export/converters/AttachmentConverter.ts`（新增）
- **展示格式**：
  ```
  ### 📎 附件
  - 📷 screenshot_2025_11_22.png (图片, 2.3 MB)
  - 📄 report.pdf (文档, 1.5 MB)
  - 📦 data.json (数据, 45 KB)
  ```
- **图标映射**：
  - 图片：📷
  - 文档：📄
  - 音频：🎵
  - 视频：🎬
  - 其他：📦
- **预估工作量**：30 分钟

#### 任务 2.5：文档样式设计

- **目标**：设计统一的 DOCX 样式主题
- **输入**：用户选择的主题模式（跟随应用主题或固定样式）
- **输出**：DOCX Document 对象（带完整样式）
- **涉及文件**：
  - `services/export/styles/DocumentStyles.ts`（新增）
- **样式要素**：
  - **页眉**：显示话题标题 + 导出时间
  - **页脚**：显示页码
  - **字体**：
    - 正文：思源黑体/Segoe UI（14pt）
    - 代码：Consolas/Monaco（12pt）
  - **颜色**：
    - 用户消息：蓝色气泡背景
    - AI 消息：灰色气泡背景
    - 思考链：浅蓝色背景
    - 工具调用：浅黄色背景
  - **间距**：段落间距 1.15 倍行高
- **预估工作量**：1 小时

#### 任务 2.6：文档生成主流程

- **目标**：整合所有转换器，生成最终 DOCX 文件
- **输入**：话题数据 + 导出选项
- **输出**：DOCX 文件（Base64 或文件路径）
- **涉及文件**：
  - `services/export/TopicExportService.ts`（完善主逻辑）
- **流程图**：
  ```
  1. 加载话题数据（标题、创建时间、消息列表）
  2. 创建 DOCX 文档对象
  3. 添加页眉（话题标题 + 导出时间）
  4. 遍历消息列表：
     a. 添加消息元信息（发送者、时间）
     b. 转换消息内容（Markdown → DOCX）
     c. 如果有思考链，根据模式添加
     d. 如果有 MCP 工具调用，添加表格
     e. 如果有附件，添加附件列表
  5. 添加页脚（页码）
  6. 保存到文件系统
  7. 返回文件路径
  ```
- **错误处理**：
  - 数据库查询失败 → 提示用户重试
  - 内存不足 → 分块处理（每次处理 50 条消息）
  - 文件写入失败 → 提示检查存储空间
- **预估工作量**：2 小时

---

### 阶段 3：UI 集成

**目标**：在应用中添加导出入口、对话框和进度提示

#### 任务 3.1：创建导出配置对话框

- **目标**：让用户选择导出选项
- **输入**：无
- **输出**：`ExportConfigDialog.tsx` 组件
- **涉及文件**：
  - `components/topics/ExportConfigDialog.tsx`（新增）
- **UI 元素**：
  - **思考链导出模式**：单选按钮（完整/摘要/不导出）
  - **包含 MCP 工具调用**：开关按钮
  - **包含附件信息**：开关按钮
  - **脱敏敏感数据**：开关按钮（默认开启）
  - **取消/确认按钮**
- **样式**：使用 `InputDialog` 风格，圆角阴影
- **预估工作量**：1 小时

#### 任务 3.2：添加导出入口

- **目标**：在话题侧边栏和详情页添加导出按钮
- **输入**：当前话题 ID
- **输出**：更新后的 UI 组件
- **涉及文件**：
  - `components/topics/TopicsSidebar.tsx`（添加右键菜单项）
  - `app/index.tsx`（添加顶部导航栏按钮）
- **交互流程**：
  1. 用户点击"导出话题"按钮
  2. 弹出 `ExportConfigDialog`
  3. 用户选择配置 → 点击确认
  4. 显示导出进度提示
  5. 完成后弹出文件分享界面
- **预估工作量**：30 分钟

#### 任务 3.3：实现导出进度提示

- **目标**：显示导出进度（防止用户误以为卡死）
- **输入**：导出任务状态
- **输出**：`ExportProgressDialog.tsx` 组件
- **涉及文件**：
  - `components/topics/ExportProgressDialog.tsx`（新增）
- **UI 元素**：
  - 进度条（使用 React Native Paper 的 ProgressBar）
  - 当前状态文字（"正在加载数据..." / "正在生成文档..." / "正在保存文件..."）
  - 取消按钮（支持中断导出）
- **技术实现**：
  - 使用 `useState` 管理进度状态
  - 在 `TopicExportService` 中添加进度回调
- **预估工作量**：1 小时

#### 任务 3.4：集成文件分享功能

- **目标**：导出完成后调用系统分享功能
- **输入**：DOCX 文件路径
- **输出**：系统分享界面
- **涉及文件**：
  - `hooks/use-topic-export.ts`（新增）
- **核心代码**：
  ```typescript
  import * as Sharing from 'expo-sharing';

  async function shareExportedFile(filePath: string) {
    const isAvailable = await Sharing.isAvailableAsync();
    if (isAvailable) {
      await Sharing.shareAsync(filePath, {
        mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        dialogTitle: '分享导出的话题',
      });
    }
  }
  ```
- **平台差异处理**：
  - iOS：使用系统分享菜单
  - Android：使用 Intent 分享
- **预估工作量**：30 分钟

---

### 阶段 4：功能完善

**目标**：错误处理、性能优化、测试验证

#### 任务 4.1：错误处理和用户提示

- **目标**：优雅处理所有异常情况
- **输入**：导出过程中的错误
- **输出**：友好的错误提示
- **涉及文件**：
  - `services/export/TopicExportService.ts`（添加 try-catch）
  - `hooks/use-topic-export.ts`（错误处理）
- **错误类型**：
  - **话题不存在**：提示"话题未找到，可能已被删除"
  - **存储空间不足**：提示"存储空间不足，请清理后重试"
  - **导出超时**（>30s）：提示"导出超时，请尝试导出更少的消息"
  - **未知错误**：提示"导出失败，请稍后重试"并记录日志
- **日志记录**：
  ```typescript
  import { logger } from '@/utils/logger';

  logger.error('TopicExport', 'Failed to export topic', { topicId, error });
  ```
- **预估工作量**：1 小时

#### 任务 4.2：性能优化

- **目标**：确保导出大型话题时不卡顿
- **输入**：话题消息数量
- **输出**：优化后的导出逻辑
- **涉及文件**：
  - `services/export/TopicExportService.ts`
- **优化策略**：
  - **分块处理**：每次处理 50 条消息，避免内存溢出
  - **异步转换**：使用 `Promise.all` 并行转换消息
  - **缓存样式对象**：避免重复创建相同样式
  - **限制思考链长度**：超过 5000 字符自动截断
- **性能目标**：
  - 100 条消息：< 5 秒
  - 500 条消息：< 15 秒
  - 1000 条消息：< 30 秒
- **预估工作量**：2 小时

#### 任务 4.3：单元测试

- **目标**：确保核心逻辑的正确性
- **输入**：服务类和转换器
- **输出**：测试文件
- **涉及文件**：
  - `services/export/__tests__/MarkdownConverter.test.ts`（新增）
  - `services/export/__tests__/TopicExportService.test.ts`（新增）
- **测试用例**：
  - Markdown 转换：标题、代码块、列表、链接
  - 思考链转换：完整模式、摘要模式、不导出
  - MCP 工具调用：脱敏、表格生成
  - 附件信息：emoji 映射、文件大小格式化
  - 文档生成：完整流程测试
- **测试工具**：Jest + React Native Testing Library
- **预估工作量**：3 小时

#### 任务 4.4：集成测试

- **目标**：在真实设备上测试完整流程
- **输入**：测试话题数据
- **输出**：测试报告
- **涉及文件**：
  - 无（手动测试）
- **测试场景**：
  - **场景 1**：导出包含 50 条消息的普通对话
  - **场景 2**：导出包含思考链的对话（完整模式）
  - **场景 3**：导出包含 MCP 工具调用的对话
  - **场景 4**：导出包含附件的对话
  - **场景 5**：导出超大话题（1000+ 条消息）
  - **场景 6**：中断导出任务
  - **场景 7**：网络异常时导出
- **验收标准**：
  - ✅ DOCX 文件可正常打开（使用 Microsoft Word / WPS / Google Docs）
  - ✅ 样式正确（字体、颜色、间距符合设计）
  - ✅ 内容完整（消息、思考链、工具调用、附件信息）
  - ✅ 敏感数据已脱敏
  - ✅ 文件分享功能正常（iOS + Android）
  - ✅ 进度提示流畅（无卡顿）
  - ✅ 错误提示友好
- **预估工作量**：2 小时

#### 任务 4.5：文档编写

- **目标**：编写用户使用文档和开发者技术文档
- **输入**：功能实现细节
- **输出**：文档文件
- **涉及文件**：
  - `docs/TOPIC_EXPORT_USER_GUIDE.md`（新增，用户指南）
  - `docs/TOPIC_EXPORT_TECH_SPEC.md`（新增，技术规格）
- **用户指南内容**：
  - 如何导出话题
  - 导出选项说明
  - 常见问题解答
- **技术规格内容**：
  - 架构设计
  - API 接口
  - 数据流图
  - 扩展指南（如何添加新的导出格式）
- **预估工作量**：1.5 小时

---

## 风险评估

### 技术风险

1. **DOCX 库兼容性问题**
   - **风险**：`docx` 库在某些 React Native 版本上可能有兼容性问题
   - **缓解措施**：
     - 在开发初期进行兼容性测试
     - 准备降级方案（使用 HTML 导出）
   - **影响**：中等
   - **概率**：低

2. **大文件内存溢出**
   - **风险**：导出超大话题（1000+ 条消息）时可能内存不足
   - **缓解措施**：
     - 分块处理消息
     - 限制单次导出的最大消息数量（如 500 条）
     - 提供"分段导出"选项
   - **影响**：高
   - **概率**：中等

3. **Markdown 解析复杂度**
   - **风险**：复杂的 Markdown 语法（如嵌套列表、表格）可能解析失败
   - **缓解措施**：
     - 使用成熟的 Markdown 解析库（如 `remark`）
     - 针对常见语法编写测试用例
     - 提供"纯文本导出"降级选项
   - **影响**：中等
   - **概率**：中等

### 用户体验风险

1. **导出时间过长**
   - **风险**：用户可能误以为应用卡死
   - **缓解措施**：
     - 显示详细的进度提示
     - 支持后台导出
     - 允许用户取消导出
   - **影响**：高
   - **概率**：高

2. **文件分享失败**
   - **风险**：某些设备上系统分享功能可能异常
   - **缓解措施**：
     - 提供"保存到相册/文件管理器"备选方案
     - 显示文件保存路径，允许用户手动复制
   - **影响**：中等
   - **概率**：低

### 数据安全风险

1. **敏感信息泄露**
   - **风险**：MCP 工具调用参数中可能包含 API Key 等敏感信息
   - **缓解措施**：
     - 默认开启脱敏功能
     - 使用白名单机制，只导出安全字段
     - 在导出前提示用户检查
   - **影响**：高
   - **概率**：中等

---

## 验收标准

### 功能完整性

- ✅ 支持导出完整的对话内容（用户消息 + AI 消息）
- ✅ 支持导出思考链（完整/摘要/不导出三种模式）
- ✅ 支持导出 MCP 工具调用（包含参数和结果）
- ✅ 支持导出附件信息（文件名、类型、大小）
- ✅ 支持自定义导出选项（通过对话框配置）
- ✅ 支持文件分享到其他应用（iOS + Android）
- ✅ 支持取消正在进行的导出任务

### 性能标准

- ✅ 100 条消息导出时间 < 5 秒
- ✅ 500 条消息导出时间 < 15 秒
- ✅ 1000 条消息导出时间 < 30 秒
- ✅ 导出过程中 UI 无明显卡顿
- ✅ 内存占用 < 150 MB（在导出 1000 条消息时）

### 质量标准

- ✅ DOCX 文件可在主流办公软件中正常打开（Word / WPS / Google Docs）
- ✅ 文档样式美观（字体、颜色、间距符合设计规范）
- ✅ 所有 Markdown 语法正确转换（标题、代码块、列表等）
- ✅ 敏感数据已脱敏（API Key、Token 等）
- ✅ 错误提示友好且可操作
- ✅ 代码通过 TypeScript 类型检查
- ✅ 核心逻辑有单元测试覆盖（覆盖率 > 80%）

### 兼容性标准

- ✅ 支持 iOS 13+ 设备
- ✅ 支持 Android 8+ 设备
- ✅ 支持深色/浅色主题
- ✅ 支持不同屏幕尺寸（手机 + 平板）

---

## 总结

本规划文档基于用户的明确决策，将话题导出功能分解为 **4 个阶段共 19 个具体任务**，预计总工作量约 **22.5 小时**。

### 关键里程碑

1. **阶段 1 完成**（预计 1.5 小时）：依赖安装完成，数据访问层扩展完成
2. **阶段 2 完成**（预计 9.5 小时）：核心 DOCX 生成逻辑完成，可生成基本文档
3. **阶段 3 完成**（预计 3 小时）：UI 集成完成，用户可完整体验导出流程
4. **阶段 4 完成**（预计 8.5 小时）：功能完善，通过所有测试，达到上线标准

### 后续扩展方向

1. **多格式导出**：支持 PDF、HTML、Markdown 等格式
2. **云端导出**：上传到 OneDrive / Google Drive / iCloud
3. **批量导出**：支持一次导出多个话题
4. **导出模板**：支持自定义文档样式模板
5. **AI 总结**：在导出前使用 AI 生成对话摘要

---

## 用户反馈区域

请在此区域补充您对整体规划的意见和建议：

```
用户补充内容：





```

---

**文档版本**：v1.0
**创建时间**：2025-11-22
**更新时间**：2025-11-22
**规划状态**：✅ 已确认所有决策，等待用户最终审核
